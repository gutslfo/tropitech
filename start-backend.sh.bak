#!/bin/bash
# Script de dÃ©marrage du backend

echo "ğŸš€ DÃ©marrage du backend Tropitech..."

# VÃ©rifier que les dossiers requis existent
echo "ğŸ” VÃ©rification des dossiers requis..."
for dir in /app/server/tickets /app/server/qrcodes /app/server/assets; do
    if [ ! -d "$dir" ]; then
        echo "ğŸ“ CrÃ©ation du dossier $dir"
        mkdir -p "$dir"
        chmod 755 "$dir"
    fi
    echo "âœ… Dossier $dir prÃªt"
done

# Tester la connexion Ã  MongoDB Atlas
echo "ğŸ” Test de connexion Ã  MongoDB Atlas..."
node -e "
const mongoose = require('mongoose');
mongoose.connect(process.env.MONGO_URI)
  .then(() => {
    console.log('âœ… Connexion Ã  MongoDB Atlas rÃ©ussie!');
    process.exit(0);
  })
  .catch(err => {
    console.error('âŒ Erreur de connexion MongoDB Atlas:', err);
    process.exit(1);
  });
"

if [ $? -ne 0 ]; then
    echo "âŒ Erreur de connexion Ã  MongoDB Atlas. VÃ©rifiez l'URI et les informations d'identification."
    exit 1
fi

# DÃ©marrer le serveur
echo "ğŸš€ DÃ©marrage du serveur Node.js..."
cd /app
exec node server/server.js